# AI API 故障排除指南

## 当前错误
**错误: 调用AI API失败，请检查网络连接和API配置**

## 排查步骤

### 1. 检查环境变量配置
打开浏览器控制台（F12），查看是否有 "API配置检查" 的日志输出。

**如果显示 "hasKey: false"**：
- `.env` 文件未正确加载
- 解决：重启开发服务器（停止后重新运行 `npm start`）

**如果显示 "hasKey: true"**：
- 环境变量已加载，继续下一步

### 2. 查看详细错误信息
在浏览器控制台（F12 → Console）查看完整的错误信息：
- 如果是 `ERR_NETWORK` 或 `CORS` 相关错误 → 网络/CORS问题
- 如果是 `401` 错误 → API密钥无效
- 如果是 `403` 错误 → API密钥权限不足或账户余额不足
- 如果是 `429` 错误 → 请求频率过高

### 3. 常见问题及解决方案

#### 问题A: CORS跨域错误
**症状：** 控制台显示 `ERR_NETWORK` 或 `CORS policy` 错误

**原因：** 浏览器阻止了跨域请求

**解决方案：**
1. **方案1（推荐）：使用国内API服务**
   - 切换到阿里云通义千问（国内访问更稳定）
   - 修改 `.env` 文件：
     ```
     REACT_APP_AI_API_KEY=你的DashScope密钥
     REACT_APP_AI_API_URL=https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation
     REACT_APP_AI_PROVIDER=dashscope
     ```

2. **方案2：使用代理/VPN**
   - 如果必须使用OpenAI，需要配置代理或VPN
   - 或者使用第三方代理服务

#### 问题B: API密钥无效（401错误）
**症状：** 错误提示 "API密钥无效"

**解决方案：**
1. 检查 `.env` 文件中的密钥是否正确（无多余空格）
2. 在 OpenAI 平台验证密钥是否有效
3. 确认密钥格式：`sk-` 开头
4. 重启开发服务器

#### 问题C: 账户余额不足（403错误）
**症状：** 错误提示 "API访问被拒绝"

**解决方案：**
1. 登录 https://platform.openai.com/
2. 检查账户余额（Billing → Credits）
3. 充值或使用免费额度

#### 问题D: 网络连接问题
**症状：** 请求超时或无法连接

**解决方案：**
1. 检查网络连接
2. 检查防火墙设置
3. 如果在中国大陆，考虑使用国内API服务（通义千问）

### 4. 验证API密钥
在浏览器控制台运行以下代码测试API密钥：

```javascript
// 在浏览器控制台运行
fetch('https://api.openai.com/v1/models', {
  headers: {
    'Authorization': 'Bearer sk-你的密钥'
  }
})
.then(r => r.json())
.then(console.log)
.catch(console.error)
```

如果返回模型列表，说明密钥有效；如果返回401，说明密钥无效。

### 5. 快速测试
1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签
3. 发送一条消息，查看控制台输出的详细错误
4. 根据错误信息对照上述解决方案

## 推荐配置（国内用户）

如果在中国大陆，建议使用阿里云通义千问：

1. 访问：https://dashscope.console.aliyun.com/
2. 获取API密钥
3. 修改 `.env` 文件：
   ```
   REACT_APP_AI_API_KEY=你的DashScope密钥
   REACT_APP_AI_API_URL=https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation
   REACT_APP_AI_PROVIDER=dashscope
   ```
4. 重启服务器

## 需要帮助？
如果以上方法都无法解决，请提供：
1. 浏览器控制台的完整错误信息（截图）
2. `.env` 文件内容（隐藏密钥，只显示前几位）
3. 网络环境（是否在中国大陆）
